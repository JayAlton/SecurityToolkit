import requests
import os
from dotenv import load_dotenv

load_dotenv()
API_URL = "https://vulners.com/api/v3/search/lucene"
API_KEY = os.getenv("VULNERS_API_KEY")

def find_vulnerabilities(fingerprints):
    results = []

    for fp in fingerprints:
        service = fp['service']
        version = fp['version']

        if service == "ssh":
            query = f"OpenSSH {version}"
        elif service == "apache":
            query = f"Apache httpd {version}"
        elif service == "nginx":
            query = f"nginx {version}"
        else:
            query = f"{service} {version}"

        print(f"Querying: {query}")
        params = {
                "query": query,
                "apiKey": API_KEY
        }
        try:
            resp = requests.get(API_URL, params=params)
            data = resp.json()

            cves = []
            for entry in data.get("data", {}).get("search", []):
                cve_id = entry.get("id") or (entry.get("cvelist") or [None])[0]
                if cve_id: # only include if there's an identifieable CVE
                    cves.append({
                        "id": cve_id,
                        "title": entry.get("title") or entry.get("description", "No title"),
                        "cvss": entry.get("cvss", {}).get("score"),
                        "href": entry.get("href")
                    })

            results.append({
                "fingerprint": fp,
                "cves": cves
            })
        except Exception as e:
            results.append({
                "fingerprint": fp,
                "cves": [],
                "error": str(e)
            })
        return results
